# 第10讲 实现评论与回复功能

tags: mongoose populate

[TOC]

## 了解`mongoose`的`populate`功能

[mongoose:populate](http://mongoosejs.com/docs/populate.html)

##  建立comment模型

在`server/models` 目录新增 `comment.js`

```js
'use strict';

var mongoose = require('mongoose');
var ObjectId = mongoose.Schema.Types.ObjectId;

var schemaComment = new mongoose.Schema({
  car: {
    type: ObjectId,
    ref: 'ModelCar'
  },
  from: {
    type: ObjectId,
    ref: 'ModelUser'
  },
  content: {
    type: String,
    required: true
  },
  meta: {
    createDate: {
      type: Date,
      default: Date.now()
    }
  }
});

schemaComment.statics = {
  fetchByCarId: function(carId,cb) {
    return this
      .find({car:carId})
      .populate('from', 'name')
      .exec(cb);
  }
};

var ModelComment = mongoose.model('ModelComment', schemaComment, 'comment');

module.exports = ModelComment;

```

> 扩展阅读
> [mongoose:schematype](http://mongoosejs.com/docs/api.html#schematype-js)
 
##  增加comment的模拟数据

在`server` 目录新增 `addDemoComment.js`

```js
'use strict';

var mongoose = require('mongoose');
var ModelComment = require('./models/comment');
var ModelCar = require('./models/car');
var ModelUser = require('./models/user');

mongoose.connect('mongodb://localhost/carShop');

ModelCar.findOne({}).exec(function(err, _car) {
  if (err) {
    console.log(err);
  }
  var carId = _car._id;

  ModelUser.findOne({}).exec(function(err, _user) {
    if (err) {
      console.log(err);
    }
    var userId = _user._id;

    var commentArray = [{
      car: carId,
      from: userId,
      content: '这是评论1....'
    }, {
      car: carId,
      from: userId,
      content: '这是评论2....'
    }, {
      car: carId,
      from: userId,
      content: '这是评论3....'
    }];
    ModelComment.create(commentArray, function(err, comments) {
      if (err) {
        console.log(err);
      } else {
        console.log('新增 %d 条记录', comments.length);
      }
      mongoose.disconnect();
    });
  });
});

```

##  详情页增加comment的视图内容


