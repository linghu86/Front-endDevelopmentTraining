# 第11讲 列表增加分页与查询

tags: 分页 mongoose skip limit

[TOC]


## 分页需要考虑的变量

注: 本讲内容为 07-work 分支

- 总记录数 totalsize
- 每页记录数 size
- 总页数 pagetotal
- 当前页数 page 从1开始

使用查询串方式

?page=<page>

?page=<page>&size=<size>

?page=<page>&size=<size>&pagetotal=<pagetotal>

?page=<page>&size=<size>&totalsize=<totalsize>

建议这种:
?page=<page>&pagetotal=<pagetotal>

## 模型增加查询方法

修改`server/models`目录下的`car.js`

```js
schemaCar.statics = {
	fetch: function(cb) {
		return this
			.find({})
			.sort('meta.createDate')
			.exec(cb);
	},
	findById: function(id, cb) {
		return this
			.findOne({
				_id: id
			})
			.exec(cb);
	},
	getCount:function(cb){
		return this.count(cb);
	},
	findByPage: function(page,size,cb){
		return this
			.find({})
			.sort('meta.createDate')
			.skip((page-1)*size)
			.limit(size)
			.exec(cb);
	}
};
```

## 修改控制器

修改`server/controllers`目录下的`car.js`

```js
module.exports.showList = function(req, res, next) {

	var size = 5;
	var page = parseInt(req.query.page);
	var pagetotal = parseInt(req.query.pagetotal);

	if (!page) {
		//第一次调用
		ModelCar.getCount(function(err, totalsize) {
			page = 1;
			pagetotal = Math.ceil(totalsize / size);
			ModelCar.findByPage(page, size, function(err, cars) {
				if (err) {
					return next(err);
				}
				res.render('car_list.jade', {
					title: '汽车商城 列表页',
					cars: cars,
					page: page,
					size: size,
					pagetotal: pagetotal
				});
			});
		});
	} else {
		ModelCar.findByPage(page, size, function(err, cars) {
			if (err) {
				return next(err);
			}
			res.render('car_list.jade', {
				title: '汽车商城 列表页',
				cars: cars,
				page: page,
				size: size,
				pagetotal: pagetotal
			});
		});
	}
};
```

## 修改视图增加页码

修改`server/views/pages`目录下的 `car_list.jade`

在表格下面增加内容:

```jade
	.container
		.row
			nav
				ul.pagination
					- for (var i=1; i<= pagetotal; i++){
						- if (i===page){
								li.active
									span #{i}
						- } else {
							li
								a(href="/admin/car/list?page=#{i}&pagetotal=#{pagetotal}") #{i}
						- }
					- }
```

测试效果.

## 修改视图增加前后箭头

```jade
	.container
		.row
			nav
				ul.pagination
					- for (var i=1; i<= pagetotal; i++){
						- if (i===1){
							- if(i===page){
									li.disabled
										span &laquo;
							- }else{
									li
										a(href="/admin/car/list?page=#{page-1}&pagetotal=#{pagetotal}")
											span &laquo;
							- }
						-	}
						- if (i===page){
								li.active
									span #{i}
						-	} else {
							li
								a(href="/admin/car/list?page=#{i}&pagetotal=#{pagetotal}") #{i}
						- }
						- if (i===pagetotal){
							- if(i===page){
									li.disabled
										span &raquo;
							- }else{
									li
										a(href="/admin/car/list?page=#{page+1}&pagetotal=#{pagetotal}")
											span &raquo;
							- }
						-	}							
					- }
```



