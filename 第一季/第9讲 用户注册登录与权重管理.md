# 第9讲 用户注册登录与权重管理

tags: bcrypt Express中间件

[TOC]

## 项目

本讲所涉及项目为第4讲创建的项目

[示例项目:CarShopDemoV1](https://github.com/qingfeng365/CarShopDemoV1)

本节内容为05-work分支

## 前端页面引入`holderjs`

`holderjs` 是生成占位图片的工具，用来做测试页面和演示页面非常方便。

在项目根目录命令窗口：

```bash
bower install holderjs
```

修改`server/views/include`目录下的 `foot.jade`

增加一行:

```jade
script(src="/bower_components/holderjs/holder.min.js")
```

## 注册与登录的路由规划


<table>
    <tr>
        <th>
            用途
        </th>
        <th>
            路由
        </th>
        <th>
            模板
        </th>        
    </tr>
    <tr>
        <td>
            注册
        </td>
        <td>
            GET /signup
        </td>
        <td>
            signup.jade
        </td>        
    </tr>
    <tr>
        <td>
            注册 post
        </td>
        <td>
            POST /signup
        </td>
        <td>
        </td>          
    </tr>
    <tr>
        <td>
            登录
        </td>
        <td>
            GET /signin
        </td>
        <td>
            signin.jade
        </td>        
    </tr>
    <tr>
        <td>
            登录 post
        </td>
        <td>
            POST /signin
        </td>
        <td>
        </td>          
    </tr>  
    <tr>
        <td>
            登出 
        </td>
        <td>
            GET /logout
        </td>
        <td>
        </td>          
    </tr>      
</table>


## 模板增加菜单

修改 `server` 目录下的 `app.js` :

增加一行:

```js
app.locals.appTitle = '汽车商城';
```

修改 `server/views/include` 目录下的 `header.jade`，内容如下：

```jade
.container
	.row.m-a-md
		nav.navbar.navbar-dark.bg-primary
			a.navbar-brand(href="/")
				img(src="holder.js/100x30?theme=sky&text=#{appTitle}")
			ul.nav.   navbar-nav
				li.nav-item.active
					a.nav-link(href='/admin/car/list') 列表
			ul.nav.navbar-nav.pull-right
				li.nav-item
					a.nav-link(href="/signin") 登录
				li.nav-item
					span.nav-link |
				li.nav-item
					a.nav-link(href="/signup") 注册
```

## 增加注册模板

在 `server/views/pages` 目录下新增 `signup.jade`

```jade
extends ../layout

block content
	.container
		.row
			.col-md-4.col-md-offset-2
				form(method="POST", action="/signup")
					.form-group.row
						label.form-control-label.col-sm-2 用户名称
						.col-sm-10
							input.form-control(type="text",
								name="user[name]",placeholder="请输入用户名称",required)
					.form-group.row
						label.form-control-label.col-sm-2 密码
						.col-sm-10
							input.form-control(type="password",
								name="user[password]",placeholder="请输入密码",required)
					.form-group.row
						.col-sm-10.col-sm-offset-2
							button.btn.btn-primary(type="submit") 提交		
```

## 增加user的controller

在 `server/controllers` 目录下新增 `user.js`

```js
'use strict';

module.exports.showSignup = function(req, res, next) {
  res.render('signup', {
    title: '汽车商城 注册页',
    user: {}
  });
}
```
## 增加注册的路由处理

在 `server` 目录，修改 `routes.js`

在前面增加:

```js
var userController = require('./controllers/user');
```

以及:


```js
app.get('/signup', userController.showSignup);
```

## user的模型

### 用户等级规划

一般而言，普通线上用户等级规划可考虑以下因素：

- 当前等级
- 活跃天数 
- 等级计算规则
- 升级剩余天数
- 等级特权

现在演示一个简单的用户等级，用数值型字段表达：

- 0   : 初始注册用户
- 10  : 已完成认证用户
- 20  : 活跃用户
- 900 : 后台用户 admin
- 999 : 超级后台用户 superadmin

### 创建car的模型

在 `server/models` 目录下，创建 `user.js`

```js
'use strict';

var mongoose = require('mongoose');

var schemaUser = new mongoose.Schema({
  name: {type: String, unique: true},
  password: String,
  level: {
    type: Number,
    default: 0
  },
  lastSigninDate:Date,
  meta: {
    createDate: {
      type: Date,
      default: Date.now()
    },
    updateDate: {
      type: Date,
      default: Date.now()
    }
  }
});

schemaUser.pre('save',function(next){
  if (!this.isNew){
    this.meta.updateDate = Date.now();
  }
  next();
});

schemaUser.statics = {
  fetch: function(cb) {
    return this
      .find({})
      .sort('meta.createDate')
      .exec(cb);
  },
  findById: function(id, cb) {
    return this
      .findOne({
        _id: id
      })
      .exec(cb);
  }
};

var ModelUser = mongoose.model('ModelUser', schemaUser, 'user');
module.exports = ModelUser;
```
### mongoose 模式类型 

[schematypes](http://mongoosejs.com/docs/schematypes.html)

### 用户密码存储

[如何安全的存储密码](http://www.williamlong.info/archives/3224.html)

由于在window环境下 `bcrypt` 模块很难安装成功。

因此改用 `bcrypt.js`，所使用的算法是一样。

[bcrypt.js](https://github.com/dcodeIO/bcrypt.js)

在项目根目录命令窗口：

```bash
npm install bcryptjs
```

**加密API:**

- 生成随机盐值 

  genSalt(rounds强度(回合数), function(err, salt盐))

  强度一般为10

- 生成加密串

  hash(s原始密码, salt盐, function(err, hash加密串))

**检查API**

- 对比密码

  compare(s输入密码, hash加密串, function(err, isMatch是匹配))


### 用户密码存储预处理

在 `server/models` 目录下，修改 `user.js`

```js
var bcrypt = require('bcryptjs');
```

修改pre(save)部份代码:

```js
schemaUser.pre('save', function(next) {
  var docUser = this;
  if (!docUser.isNew) {
    docUser.meta.updateDate = Date.now();
  }
  bcrypt.genSalt(10, function(err, salt) {
    if (err) {
      return next(err);
    }
    console.log('bcrypt.genSalt');
    console.log(this);
    bcrypt.hash(docUser.password, salt, function(err, hash) {
      if (err) {
        return next(err);
      }
      console.log('bcrypt.hash');
      console.log(this);
      docUser.password = hash;
      next();
    });
  });
});
```

### 用户controller

修改`server/controllers`目录下的 `user.js`

在前面增加:

```js
var ModelUser = require('../models/user');
```

增加以下代码:

```js
module.exports.postSignup = function(req, res, next) {
  var userObj = req.body.user;
  if (!userObj) {
    return res.status(400).send('找不到合法数据.');
  }
  var docUser = new ModelUser(userObj);
  docUser.save(function(err, _user) {
    if (err) {
      return next(err);
    }
    return res.redirect('/');
  });
};
```
### 路由处理

修改`server`目录下的`routes.js`

增加以下代码:

```js
  app.post('/signup', userController.postSignup);
```

















